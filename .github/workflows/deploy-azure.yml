name: Deploy SGTNApi to Azure

on:
  push:
    branches: [ "master" ]

env:
  RESOURCE_GROUP: 'resourceGroupDemo'
  CONTAINER_APP_NAME: 'sgtnapi'
  CONTAINER_APP_ENVIRONMENT: 'sgtn-env'

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Azure CLI
      run: |
        az extension add --name containerapp --upgrade --yes

    - name: Login to Azure
      run: |
        echo "🔐 Logging in to Azure..."
        az login --service-principal \
          -u "3d7f9bdc-861d-4ddb-8c7b-802305e6ab76" \
          -p "LFY8Q~DZ.Rxn6E_2GMCqkt8hfPfgn5IceHiljbxh" \
          --tenant "4a0d0c24-fde5-4251-9a91-4b8bcb6ec907"

    - name: Set Specific Subscription
      run: |
        echo "🎯 Setting specific subscription..."
        az account set --subscription "d295f3ef-64f0-4818-9310-8aca7a966f19"
        
        echo "✅ Current subscription:"
        az account show --query "{Name:name, Id:id, Tenant:tenantId}" --output table

    - name: Deploy to Azure Container Apps
      run: |
        echo "🚀 Deploying to Azure Container Apps..."
        az containerapp up \
          --name "${{ env.CONTAINER_APP_NAME }}" \
          --resource-group "${{ env.RESOURCE_GROUP }}" \
          --environment "${{ env.CONTAINER_APP_ENVIRONMENT }}" \
          --location eastus \
          --source . \
          --ingress external \
          --target-port 80

    - name: Get Application URL
      run: |
        APP_URL=$(az containerapp show \
          --name "${{ env.CONTAINER_APP_NAME }}" \
          --resource-group "${{ env.RESOURCE_GROUP }}" \
          --query properties.configuration.ingress.fqdn \
          -o tsv)
        echo "🎉 Deployment Successful!"
        echo "🌐 Your App URL: https://$APP_URL"
        echo "💚 Health Check: https://$APP_URL/health"
        echo "🔗 API: https://$APP_URL/api/clients"